# Lab: SQL Injection Vulnerability in WHERE Clause Allowing Retrieval of Hidden Data

**M·ª•c ti√™u:** Khai th√°c l·ªó h·ªïng SQL Injection ƒë·ªÉ hi·ªÉn th·ªã c√°c d·ªØ li·ªáu (s·∫£n ph·∫©m) ƒëang b·ªã ·∫©n tr√™n trang web.

---
## üìë M·ª•c l·ª•c
- [Lab: SQL Injection Vulnerability in WHERE Clause Allowing Retrieval of Hidden Data](#lab-sql-injection-vulnerability-in-where-clause-allowing-retrieval-of-hidden-data)
  - [üìë M·ª•c l·ª•c](#-m·ª•c-l·ª•c)
  - [I. Qu√° tr√¨nh ph√¢n t√≠ch v√† khai th√°c (Ph·∫ßn ch√≠nh)](#i-qu√°-tr√¨nh-ph√¢n-t√≠ch-v√†-khai-th√°c-ph·∫ßn-ch√≠nh)
    - [1. X√°c ƒë·ªãnh ƒëi·ªÉm ch·∫°m (Injection Point)](#1-x√°c-ƒë·ªãnh-ƒëi·ªÉm-ch·∫°m-injection-point)
    - [2. Thu th·∫≠p th√¥ng tin Database (Fingerprinting)](#2-thu-th·∫≠p-th√¥ng-tin-database-fingerprinting)
    - [3. Khai th√°c th√¥ng tin c·∫•u h√¨nh v√† ph√¢n quy·ªÅn](#3-khai-th√°c-th√¥ng-tin-c·∫•u-h√¨nh-v√†-ph√¢n-quy·ªÅn)
    - [4. Th·ª≠ nghi·ªám khai th√°c n√¢ng cao (Advanced Exploitation)](#4-th·ª≠-nghi·ªám-khai-th√°c-n√¢ng-cao-advanced-exploitation)
    - [5. Ho√†n th√†nh m·ª•c ti√™u b√†i Lab](#5-ho√†n-th√†nh-m·ª•c-ti√™u-b√†i-lab)
  - [II. Ph·∫ßn m·ªü r·ªông: Chaining Vulnerabilities](#ii-ph·∫ßn-m·ªü-r·ªông-chaining-vulnerabilities)
    - [1. Ph√¢n t√≠ch l·ªó h·ªïng Reflected XSS](#1-ph√¢n-t√≠ch-l·ªó-h·ªïng-reflected-xss)
    - [2. Ph√¢n t√≠ch l·ªó h·ªïng Local File Inclusion (LFI)](#2-ph√¢n-t√≠ch-l·ªó-h·ªïng-local-file-inclusion-lfi)
---
## I. Qu√° tr√¨nh ph√¢n t√≠ch v√† khai th√°c (Ph·∫ßn ch√≠nh)

### 1. X√°c ƒë·ªãnh ƒëi·ªÉm ch·∫°m (Injection Point)
Khi truy c·∫≠p trang web, giao di·ªán hi·ªÉn th·ªã ch·ª©c nƒÉng xem s·∫£n ph·∫©m theo danh m·ª•c v√† xem chi ti·∫øt s·∫£n ph·∫©m. 
![Giao di·ªán trang ch·ªß](https://github.com/user-attachments/assets/693c8783-edbd-42e2-a19d-3491a8f250f3)
![Giao di·ªán trang ch·ªß](https://github.com/user-attachments/assets/bc4f90e8-9f68-482a-91bb-9441669fca58)
D·ª±a tr√™n l√Ω thuy·∫øt, c√°c ch·ª©c nƒÉng nh∆∞ Search, Filter, Sort th∆∞·ªùng s·ª≠ d·ª•ng truy v·∫•n SQL ƒë·ªÉ x√¢y d·ª±ng m·ªánh ƒë·ªÅ `WHERE` ho·∫∑c `ORDER BY`. Ki·ªÉm tra ch·ª©c nƒÉng Filter theo Category:
![Ch·ª©c nƒÉng filter](https://github.com/user-attachments/assets/0c209b54-366a-4130-bcd6-5000b737c8bd)

Tham s·ªë `category` tr√™n URL l√† m·ªôt ƒëi·ªÉm v√†o ph·ªï bi·∫øn[cite: 12]. Th·ª≠ ch√®n k√Ω t·ª± `'` v√†o gi√° tr·ªã c·ªßa tham s·ªë n√†y[cite: 13]:
![B√°o l·ªói 500](https://github.com/user-attachments/assets/1b8bb72f-15f5-468c-a931-1098c4f884df)

> **K·∫øt qu·∫£:** Server tr·∫£ v·ªÅ status code `500 Internal Server Error`. Do gi√° tr·ªã tham s·ªë l√† chu·ªói, kh·∫£ nƒÉng l·ªói do √©p ki·ªÉu l√† r·∫•t th·∫•p, t√≠n hi·ªáu n√†y cho th·∫•y h·ªá th·ªëng c√≥ kh·∫£ nƒÉng cao d√≠nh SQL Injection do l·ªói c√∫ ph√°p.

ƒê·ªÉ ki·ªÉm ch·ª©ng, ch√®n th√™m k√Ω t·ª± comment `--` ph·ªï bi·∫øn trong c√°c c∆° s·ªü d·ªØ li·ªáu:
`'--`
![Ph·∫£n h·ªìi b√¨nh th∆∞·ªùng]([Link_·∫£nh_4_c·ªßa_b·∫°n_v√†o_ƒë√¢y](https://github.com/user-attachments/assets/9e7735c7-362e-4b17-8d57-5c66435d96bd))
Trang web ph·∫£n h·ªìi b√¨nh th∆∞·ªùng! ƒêi·ªÅu n√†y kh·∫≥ng ƒë·ªãnh ch·∫Øc ch·∫Øn tham s·ªë `category` m·∫Øc l·ªói SQL Injection.

### 2. Thu th·∫≠p th√¥ng tin Database (Fingerprinting)
V√¨ d·ªØ li·ªáu ƒë∆∞·ª£c tr·∫£ v·ªÅ tr·ª±c ti·∫øp tr√™n ph·∫£n h·ªìi HTML, h∆∞·ªõng khai th√°c t·ªët nh·∫•t l√† s·ª≠ d·ª•ng **UNION Based SQLi** ƒë·ªÉ tr√≠ch xu·∫•t th√™m th√¥ng tin.

**X√°c ƒë·ªãnh s·ªë l∆∞·ª£ng c·ªôt:** S·ª≠ d·ª•ng `ORDER BY` ƒë·ªÉ tƒÉng d·∫ßn s·ªë l∆∞·ª£ng c·ªôt cho ƒë·∫øn khi g·∫∑p l·ªói:
* `' ORDER BY 8--` (Th√†nh c√¥ng) 
![](https://github.com/user-attachments/assets/52c3fa70-f117-4597-b076-9fd2103fcc8c)
* `' ORDER BY 9--` (L·ªói 500) 
![](https://github.com/user-attachments/assets/ec5448ed-ce3a-4f72-ad0f-a225df430bc6)
=> Truy v·∫•n g·ªëc tr·∫£ v·ªÅ **8 c·ªôt**.

**X√°c ƒë·ªãnh ki·ªÉu d·ªØ li·ªáu:**
S·ª≠ d·ª•ng `UNION SELECT NULL` v√† thay d·∫ßn b·∫±ng chu·ªói `'a'` ƒë·ªÉ x√°c ƒë·ªãnh ki·ªÉu d·ªØ li·ªáu t·ª´ng c·ªôt.
![](https://github.com/user-attachments/assets/d76b2594-9c8b-4efd-8686-ce04e8f533a0)
![](https://github.com/user-attachments/assets/b6990116-1202-4769-8254-77b81c0796a5)
`' UNION SELECT 1, 'a', 'b', 2, 3, 'c', 4, 'd'--`
=> ƒê√£ mapping ƒë∆∞·ª£c c√°c c·ªôt ch·ª©a d·ªØ li·ªáu s·ªë v√† chu·ªói. Qu√° tr√¨nh n√†y kh√¥ng c·∫ßn s·ª≠ d·ª•ng `FROM dual`, qua ƒë√≥ lo·∫°i b·ªè ƒë∆∞·ª£c Oracle DB kh·ªèi danh s√°ch nghi ng·ªù.

**X√°c ƒë·ªãnh phi√™n b·∫£n h·ªá qu·∫£n tr·ªã CSDL (DBMS):**
Th·ª≠ c√°c h√†m l·∫•y version t·∫°i v·ªã tr√≠ c·ªôt chu·ªói:
* `@@version`: L·ªói 500 => Lo·∫°i b·ªè MySQL v√† MSSQL.
![](https://github.com/user-attachments/assets/52d47d5f-e442-45cc-8249-d9fed9cc4e5e)
* `version()`: Kh√¥ng b√°o l·ªói, nh∆∞ng kh√¥ng hi·ªÉn th·ªã tr√™n giao di·ªán. Th·ª≠ ƒë·ªïi v·ªã tr√≠ sang c·ªôt kh√°c (c·ªôt c√≥ gi√° tr·ªã 'b') ƒëang ƒë∆∞·ª£c in ra m√†n h√¨nh.
![Phi√™n b·∫£n DB](https://github.com/user-attachments/assets/4868c70e-7923-48d0-964d-5bd1fe782646)
=> X√°c ƒë·ªãnh th√†nh c√¥ng h·ªá th·ªëng s·ª≠ d·ª•ng **PostgreSQL 12.22**.

### 3. Khai th√°c th√¥ng tin c·∫•u h√¨nh v√† ph√¢n quy·ªÅn
Sau khi bi·∫øt h·ªá th·ªëng d√πng PostgreSQL, ti·∫øp t·ª•c tr√≠ch xu·∫•t th√¥ng tin User v√† Database hi·ªán t·∫°i:
`' UNION SELECT 111, 'a', current_user || '~' || current_database(), 222, 333, 'd' ...`
=> **User hi·ªán t·∫°i:** `peter` | **Database:** `academy_labs`.
![](https://github.com/user-attachments/assets/715a6dc1-a3f5-4857-b1a2-f6a4d54d3342)
Ki·ªÉm tra quy·ªÅn h·∫°n c·ªßa user `peter`:
* Quy·ªÅn `Superuser`: Tr·∫£ v·ªÅ `off` (Kh√¥ng c√≥).
![](https://github.com/user-attachments/assets/fbcf3f70-3370-47e2-a766-03774c460144)
* Quy·ªÅn `pg_read_server_files`: Tr·∫£ v·ªÅ `false` (Kh√¥ng c√≥).
![](https://github.com/user-attachments/assets/678103d1-dcc1-4d31-94ea-da38c2440c1b)
* Quy·ªÅn `pg_execute_server_program`: Tr·∫£ v·ªÅ `false` (Kh√¥ng c√≥).
![](https://github.com/user-attachments/assets/c956bc6a-961b-4d83-bc8f-0e6abd07033e)
Ki·ªÉm tra c√°c b·∫£ng hi·ªán c√≥:
Truy v·∫•n `information_schema.tables` cho th·∫•y ch·ªâ t·ªìn t·∫°i b·∫£ng `products`[cite: 48, 49]. 
Ti·∫øp t·ª•c li·ªát k√™ quy·ªÅn c·ªßa user tr√™n b·∫£ng n√†y:
`' UNION SELECT 111, 'a', string_agg(privilege_type, ','), ... FROM information_schema.table_privileges WHERE table_name='products'`
=> B·∫•t ng·ªù l√† user c√≥ r·∫•t nhi·ªÅu quy·ªÅn: `INSERT, SELECT, UPDATE, DELETE,...`[cite: 50, 51].

### 4. Th·ª≠ nghi·ªám khai th√°c n√¢ng cao (Advanced Exploitation)
D√π c√≥ nhi·ªÅu quy·ªÅn, ƒëi·ªÉm injection l·∫°i n·∫±m trong m·ªánh ƒë·ªÅ `WHERE` c·ªßa m·ªôt l·ªánh `SELECT`[cite: 52]. Th·ª≠ d√πng Stacked Queries (th√™m d·∫•u `;`) nh∆∞ng b·ªã ch·∫∑n (tr·∫£ v·ªÅ l·ªói 500 ngay)[cite: 53, 54].

Ti·∫øn h√†nh th·ª≠ nghi·ªám **Data-Modifying CTE** (S·ª≠ d·ª•ng l·ªánh `WITH` c·ªßa PostgreSQL ƒë·ªÉ ch√®n l·ªánh UPDATE/INSERT v√†o trong SELECT)[cite: 56, 57]:
`' UNION SELECT 111, 'a', (WITH updated AS (UPDATE products SET name = 'PENTEST_SUCCESS' WHERE id=1 RETURNING name) SELECT COALESCE((SELECT name::text FROM updated LIMIT 1), 'Update_Failed')) ...`

**T·∫•t c·∫£ c√°c n·ªó l·ª±c INSERT, UPDATE, DELETE b·∫±ng CTE ƒë·ªÅu th·∫•t b·∫°i (L·ªói 500)**[cite: 74, 75, 78]. Nguy√™n nh√¢n c√≥ th·ªÉ do 1 trong 4 l√Ω do k·ªπ thu·∫≠t sau:
1. **Gi·ªõi h·∫°n c·ªßa PostgreSQL:** Query Planner t·ª´ ch·ªëi th·ª±c thi DML l·ªìng trong UNION SELECT v√¨ kh√¥ng ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n d·ªØ li·ªáu[cite: 80, 81].
2. **Database Driver:** T·ª± ƒë·ªông ng·∫Øt k·∫øt n·ªëi khi ph√°t hi·ªán t·ª´ kh√≥a DML l·ªìng b√™n trong l·ªánh g·ªüi t·ªõi Database Server[cite: 82, 84].
3. **Quy tr√¨nh "Atomic" c·ªßa UNION:** K·∫øt qu·∫£ tr·∫£ v·ªÅ t·ª´ `RETURNING` kh√¥ng kh·ªõp ho√†n h·∫£o v·ªõi ƒë·ªãnh d·∫°ng c·ªôt/ki·ªÉu d·ªØ li·ªáu ƒë√£ ƒë·ªãnh s·∫µn[cite: 85, 88].
4. **WAF / Database Firewall:** Ch·∫∑n ƒë·ª©ng t·ªï h·ª£p b·∫•t th∆∞·ªùng `UNION + UPDATE/INSERT/DELETE`[cite: 89, 91].

*L∆∞u √Ω: M·∫∑c d√π c√°c t√°c ƒë·ªông thay ƒë·ªïi d·ªØ li·ªáu b·ªã ch·∫∑n, nh∆∞ng vi·ªác v√¥ hi·ªáu h√≥a log h·ªá th·ªëng b·∫±ng h√†m `set_config` l·∫°i th√†nh c√¥ng[cite: 93, 94].*

### 5. Ho√†n th√†nh m·ª•c ti√™u b√†i Lab
Quay tr·ªü l·∫°i v·ªõi m·ª•c ti√™u ban ƒë·∫ßu. B·∫£ng `products` c√≥ c·ªôt `released` (ph√°t h√†nh)[cite: 96]. Kh·∫£ nƒÉng cao ·ª©ng d·ª•ng ƒëang d√πng ƒëi·ªÅu ki·ªán ·∫©n c√°c s·∫£n ph·∫©m ch∆∞a ph√°t h√†nh[cite: 97]. 
ƒê·ªÉ b·ªè qua ƒëi·ªÅu ki·ªán n√†y v√† hi·ªÉn th·ªã to√†n b·ªô s·∫£n ph·∫©m, ta ch√®n bi·ªÉu th·ª©c logic lu√¥n ƒë√∫ng `OR 1=1`[cite: 98]:

`' OR 1=1--`
![Ho√†n th√†nh lab](Link_·∫£nh_6_c·ªßa_b·∫°n_v√†o_ƒë√¢y)
=> **K·∫øt qu·∫£:** Li·ªát k√™ th√†nh c√¥ng to√†n b·ªô s·∫£n ph·∫©m. Lab Solved! [cite: 100]

---

## II. Ph·∫ßn m·ªü r·ªông: Chaining Vulnerabilities

Trong qu√° tr√¨nh thay th·∫ø c√°c gi√° tr·ªã gi·∫£ (`'tmt1'`, `'tmt2'`,...) v√†o c√°c c·ªôt c·ªßa `UNION SELECT` ƒë·ªÉ t√¨m v·ªã tr√≠ ph·∫£n chi·∫øu (reflection) d·ªØ li·ªáu l√™n giao di·ªán, t√¥i ƒë√£ ph√°t hi·ªán m·ªôt s·ªë ƒëi·ªÉm th√∫ v·ªã[cite: 103, 104]:

* **C·ªôt 1 & 4:** Ph·∫£n chi·∫øu v√†o thu·ªôc t√≠nh `href` c·ªßa th·∫ª `<a>`, nh∆∞ng ch·ªâ nh·∫≠n gi√° tr·ªã s·ªë => Kh·∫£ nƒÉng t·∫•n c√¥ng th·∫•p[cite: 105, 106, 109, 110].
* **C·ªôt 3:** Ph·∫£n chi·∫øu v√†o n·ªôi dung th·∫ª `<h3>` => B·ªã HTML encode, kh√≥ ch√®n th·∫ª m·ªõi[cite: 107, 108, 114].
* **C·ªôt 6:** Ph·∫£n chi·∫øu v√†o thu·ªôc t√≠nh `src` c·ªßa th·∫ª `<img>` => **M·ª•c ti√™u r·∫•t ti·ªÅm nƒÉng!**[cite: 111, 112, 113].

### 1. Ph√¢n t√≠ch l·ªó h·ªïng Reflected XSS
V√¨ c·ªôt 6 n·∫±m trong thu·ªôc t√≠nh c·ªßa th·∫ª HTML, ta c√≥ th·ªÉ d√πng k·ªπ thu·∫≠t tho√°t kh·ªèi thu·ªôc t√≠nh v√† ch√®n th√™m event handler ƒë·ªôc h·∫°i[cite: 115].
Payload th·ª≠ nghi·ªám:
`' UNION SELECT 111, 'tmt1', 'tmt2', 222, 333, 'tmt3" onerror="alert(1)', 444, 'tmt4'--`

![K√≠ch ho·∫°t XSS](Link_·∫£nh_7_c·ªßa_b·∫°n_v√†o_ƒë√¢y)
Khi truy c·∫≠p trang t·ª´ tr√¨nh duy·ªát, m√£ JavaScript `alert(1)` ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t! [cite: 116, 117]
=> **K·∫øt lu·∫≠n:** L·ªó h·ªïng SQL Injection ƒë√£ tr·ªü th√†nh vector ƒë·ªÉ khai th√°c th√™m l·ªó h·ªïng **Reflected XSS**[cite: 118].

### 2. Ph√¢n t√≠ch l·ªó h·ªïng Local File Inclusion (LFI)
V√¨ c√≥ th·ªÉ ki·ªÉm so√°t gi√° tr·ªã `src` trong th·∫ª `<img>`, t√¥i ƒë√£ th·ª≠ nh√∫ng ƒë∆∞·ªùng d·∫´n file h·ªá th·ªëng ƒë·ªÉ √©p ƒë·ªçc file n·ªôi b·ªô[cite: 119]:
`../../../../../../../../etc/passwd`

Khi m·ªü ·∫£nh trong tab m·ªõi, server tr·∫£ v·ªÅ `Not Found`[cite: 120, 121].
=> L√Ω do c√≥ th·ªÉ do server ƒë√£ c·ªë ƒë·ªãnh ƒë∆∞·ªùng d·∫´n trong th∆∞ m·ª•c `/image` ho·∫∑c c√≥ c√°c r√†ng bu·ªôc b·∫£o m·∫≠t kh√°c[cite: 121].
